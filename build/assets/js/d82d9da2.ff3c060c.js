"use strict";(self.webpackChunkknowledgebase=self.webpackChunkknowledgebase||[]).push([[791],{3905:(e,t,n)=>{n.d(t,{Zo:()=>h,kt:()=>d});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var r=a.createContext({}),c=function(e){var t=a.useContext(r),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},h=function(e){var t=c(e.components);return a.createElement(r.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,s=e.originalType,r=e.parentName,h=l(e,["components","mdxType","originalType","parentName"]),p=c(n),d=o,u=p["".concat(r,".").concat(d)]||p[d]||m[d]||s;return n?a.createElement(u,i(i({ref:t},h),{},{components:n})):a.createElement(u,i({ref:t},h))}));function d(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var s=n.length,i=new Array(s);i[0]=p;var l={};for(var r in t)hasOwnProperty.call(t,r)&&(l[r]=t[r]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var c=2;c<s;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},8695:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>r,contentTitle:()=>i,default:()=>m,frontMatter:()=>s,metadata:()=>l,toc:()=>c});var a=n(7462),o=(n(7294),n(3905));const s={},i="Working with Transactions and the DBAPI",l={unversionedId:"Backend/Python Backend/Python ORM/Data Transaction",id:"Backend/Python Backend/Python ORM/Data Transaction",title:"Working with Transactions and the DBAPI",description:"With the  Engine  object ready to go, we may now proceed to dive into the basic operation of an  Engine  and its primary interactive endpoints, the  Connection  and  Result. We will additionally introduce the ORM\u2019s  facade  for these objects, known as the  Session.",source:"@site/docs/Backend/Python Backend/Python ORM/Data Transaction.md",sourceDirName:"Backend/Python Backend/Python ORM",slug:"/Backend/Python Backend/Python ORM/Data Transaction",permalink:"/knowledgebase/docs/Backend/Python Backend/Python ORM/Data Transaction",draft:!1,editUrl:"https://sayanmondal2098.github.io/knowledgebase/docs/docs/Backend/Python Backend/Python ORM/Data Transaction.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Create Table",permalink:"/knowledgebase/docs/Backend/Python Backend/Python ORM/Create Table"},next:{title:"Establishing Connectivity - the Engine",permalink:"/knowledgebase/docs/Backend/Python Backend/Python ORM/Establish Connection"}},r={},c=[{value:"Getting a Connection",id:"getting-a-connection",level:2},{value:"Committing Changes",id:"committing-changespermalink-to-this-heading",level:2},{value:"Basics of Statement Execution",id:"basics-of-statement-executionpermalink-to-this-heading",level:2},{value:"Fetching Rows",id:"fetching-rowspermalink-to-this-heading",level:3},{value:"Sending Parameters",id:"sending-parameterspermalink-to-this-heading",level:3},{value:"Sending Multiple Parameters",id:"sending-multiple-parameterspermalink-to-this-heading",level:3},{value:"Executing with an ORM Session",id:"executing-with-an-orm-sessionpermalink-to-this-heading",level:2}],h={toc:c};function m(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,a.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"working-with-transactions-and-the-dbapi"},"Working with Transactions and the DBAPI"),(0,o.kt)("p",null,"With the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Engine",title:"sqlalchemy.engine.Engine"},(0,o.kt)("inlineCode",{parentName:"a"},"Engine")),"  object ready to go, we may now proceed to dive into the basic operation of an  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Engine",title:"sqlalchemy.engine.Engine"},(0,o.kt)("inlineCode",{parentName:"a"},"Engine")),"  and its primary interactive endpoints, the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Connection",title:"sqlalchemy.engine.Connection"},(0,o.kt)("inlineCode",{parentName:"a"},"Connection")),"  and  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Result",title:"sqlalchemy.engine.Result"},(0,o.kt)("inlineCode",{parentName:"a"},"Result")),". We will additionally introduce the ORM\u2019s  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/glossary.html#term-facade"},"facade"),"  for these objects, known as the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/orm/session_api.html#sqlalchemy.orm.Session",title:"sqlalchemy.orm.Session"},(0,o.kt)("inlineCode",{parentName:"a"},"Session")),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Note to ORM readers")),(0,o.kt)("p",null,"When using the ORM, the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Engine",title:"sqlalchemy.engine.Engine"},(0,o.kt)("inlineCode",{parentName:"a"},"Engine")),"  is managed by another object called the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/orm/session_api.html#sqlalchemy.orm.Session",title:"sqlalchemy.orm.Session"},(0,o.kt)("inlineCode",{parentName:"a"},"Session")),". The  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/orm/session_api.html#sqlalchemy.orm.Session",title:"sqlalchemy.orm.Session"},(0,o.kt)("inlineCode",{parentName:"a"},"Session")),"  in modern SQLAlchemy emphasizes a transactional and SQL execution pattern that is largely identical to that of the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Connection",title:"sqlalchemy.engine.Connection"},(0,o.kt)("inlineCode",{parentName:"a"},"Connection")),"  discussed below, so while this subsection is Core-centric, all of the concepts here are essentially relevant to ORM use as well and is recommended for all ORM learners. The execution pattern used by the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Connection",title:"sqlalchemy.engine.Connection"},(0,o.kt)("inlineCode",{parentName:"a"},"Connection")),"  will be contrasted with that of the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/orm/session_api.html#sqlalchemy.orm.Session",title:"sqlalchemy.orm.Session"},(0,o.kt)("inlineCode",{parentName:"a"},"Session")),"  at the end of this section."),(0,o.kt)("p",null,"As we have yet to introduce the SQLAlchemy Expression Language that is the primary feature of SQLAlchemy, we will make use of one simple construct within this package called the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/sqlelement.html#sqlalchemy.sql.expression.text",title:"sqlalchemy.sql.expression.text"},(0,o.kt)("inlineCode",{parentName:"a"},"text()")),"  construct, which allows us to write SQL statements as  ",(0,o.kt)("strong",{parentName:"p"},"textual SQL"),". Rest assured that textual SQL in day-to-day SQLAlchemy use is by far the exception rather than the rule for most tasks, even though it always remains fully available."),(0,o.kt)("h2",{id:"getting-a-connection"},"Getting a Connection"),(0,o.kt)("p",null,"The sole purpose of the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Engine",title:"sqlalchemy.engine.Engine"},(0,o.kt)("inlineCode",{parentName:"a"},"Engine")),"  object from a user-facing perspective is to provide a unit of connectivity to the database called the  ","[",(0,o.kt)("inlineCode",{parentName:"p"},"Connection"),"]",". When working with the Core directly, the  ","[",(0,o.kt)("inlineCode",{parentName:"p"},"Connection"),"]"," object is how all interaction with the database is done. As the  ","[",(0,o.kt)("inlineCode",{parentName:"p"},"Connection"),"]"," represents an open resource against the database, we want to always limit the scope of our use of this object to a specific context, and the best way to do that is by using Python context manager form, also known as  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.python.org/3/reference/compound_stmts.html#with"},"the with statement"),". Below we illustrate \u201cHello World\u201d, using a textual SQL statement. Textual SQL is emitted using a construct called  ","[",(0,o.kt)("inlineCode",{parentName:"p"},"text()"),"]"," that will be discussed in more detail later:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"from sqlalchemy import text\nwith engine.connect() as conn:\n    result = conn.execute(text(\"select 'hello world'\"))\n    print(result.all())\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"BEGIN  (implicit)\nselect  'hello world'\n[...]  ()\n\n[('hello world',)]\n\nROLLBACK\n")),(0,o.kt)("p",null,"In the above example, the context manager provided for a database connection and also framed the operation inside of a transaction. The default behavior of the Python DBAPI includes that a transaction is always in progress; when the scope of the connection is  ","[released]",", a ROLLBACK is emitted to end the transaction. The transaction is  ",(0,o.kt)("strong",{parentName:"p"},"not committed automatically"),"; when we want to commit data we normally need to call  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Connection.commit",title:"sqlalchemy.engine.Connection.commit"},(0,o.kt)("inlineCode",{parentName:"a"},"Connection.commit()")),"  as we\u2019ll see in the next section."),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u201cautocommit\u201d mode is available for special cases. The section  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#dbapi-autocommit"},"Setting Transaction Isolation Levels including DBAPI Autocommit"),"  discusses this.")),(0,o.kt)("p",null,"The result of our SELECT was also returned in an object called  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Result",title:"sqlalchemy.engine.Result"},(0,o.kt)("inlineCode",{parentName:"a"},"Result")),"  that will be discussed later, however for the moment we\u2019ll add that it\u2019s best to ensure this object is consumed within the \u201cconnect\u201d block, and is not passed along outside of the scope of our connection."),(0,o.kt)("h2",{id:"committing-changespermalink-to-this-heading"},"Committing Changes",(0,o.kt)("a",{parentName:"h2",href:"https://docs.sqlalchemy.org/en/20/tutorial/dbapi_transactions.html#committing-changes",title:"Permalink to this heading"})),(0,o.kt)("p",null,"We just learned that the DBAPI connection is non-autocommitting. What if we want to commit some data? We can alter our above example to create a table and insert some data, and the transaction is then committed using the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Connection.commit",title:"sqlalchemy.engine.Connection.commit"},(0,o.kt)("inlineCode",{parentName:"a"},"Connection.commit()")),"  method, invoked  ",(0,o.kt)("strong",{parentName:"p"},"inside"),"  the block where we acquired the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Connection",title:"sqlalchemy.engine.Connection"},(0,o.kt)("inlineCode",{parentName:"a"},"Connection")),"  object:"),(0,o.kt)("h1",{id:"commit-as-you-go"},'"commit as you go"'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'>>> with engine.connect() as conn:\n...     conn.execute(text("CREATE TABLE some_table (x int, y int)"))\n...     conn.execute(\n...         text("INSERT INTO some_table (x, y) VALUES (:x, :y)"),\n...         [{"x": 1, "y": 1}, {"x": 2, "y": 4}],\n...     )\n...     conn.commit()\n\nBEGIN  (implicit)\nCREATE  TABLE  some_table  (x  int,  y  int)\n[...]  ()\n<sqlalchemy.engine.cursor.CursorResult  object  at  0x...>\nINSERT  INTO  some_table  (x,  y)  VALUES  (?,  ?)\n[...]  [(1,  1),  (2,  4)]\n<sqlalchemy.engine.cursor.CursorResult  object  at  0x...>\nCOMMIT\n')),(0,o.kt)("p",null,"Above, we emitted two SQL statements that are generally transactional, a \u201cCREATE TABLE\u201d statement  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/tutorial/dbapi_transactions.html#id2"},"[1]"),"  and an \u201cINSERT\u201d statement that\u2019s parameterized (the parameterization syntax above is discussed a few sections below in  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/tutorial/dbapi_transactions.html#tutorial-multiple-parameters"},"Sending Multiple Parameters"),"). As we want the work we\u2019ve done to be committed within our block, we invoke the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Connection.commit",title:"sqlalchemy.engine.Connection.commit"},(0,o.kt)("inlineCode",{parentName:"a"},"Connection.commit()")),"  method which commits the transaction. After we call this method inside the block, we can continue to run more SQL statements and if we choose we may call  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Connection.commit",title:"sqlalchemy.engine.Connection.commit"},(0,o.kt)("inlineCode",{parentName:"a"},"Connection.commit()")),"  again for subsequent statements. SQLAlchemy refers to this style as  ",(0,o.kt)("strong",{parentName:"p"},"commit as you go"),"."),(0,o.kt)("p",null,"There is also another style of committing data, which is that we can declare our \u201cconnect\u201d block to be a transaction block up front. For this mode of operation, we use the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Engine.begin",title:"sqlalchemy.engine.Engine.begin"},(0,o.kt)("inlineCode",{parentName:"a"},"Engine.begin()")),"  method to acquire the connection, rather than the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Engine.connect",title:"sqlalchemy.engine.Engine.connect"},(0,o.kt)("inlineCode",{parentName:"a"},"Engine.connect()")),"  method. This method will both manage the scope of the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Connection",title:"sqlalchemy.engine.Connection"},(0,o.kt)("inlineCode",{parentName:"a"},"Connection")),"  and also enclose everything inside of a transaction with COMMIT at the end, assuming a successful block, or ROLLBACK in case of exception raise. This style may be referred towards as  ",(0,o.kt)("strong",{parentName:"p"},"begin once"),":"),(0,o.kt)("h1",{id:"begin-once"},'"begin once"'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'>>> with engine.begin() as conn:\n...     conn.execute(\n...         text("INSERT INTO some_table (x, y) VALUES (:x, :y)"),\n...         [{"x": 6, "y": 8}, {"x": 9, "y": 10}],\n...     )\n\nBEGIN  (implicit)\nINSERT  INTO  some_table  (x,  y)  VALUES  (?,  ?)\n[...]  [(6,  8),  (9,  10)]\n<sqlalchemy.engine.cursor.CursorResult  object  at  0x...>\nCOMMIT\n')),(0,o.kt)("p",null,"\u201cBegin once\u201d style is often preferred as it is more succinct and indicates the intention of the entire block up front. However, within this tutorial we will normally use \u201ccommit as you go\u201d style as it is more flexible for demonstration purposes."),(0,o.kt)("p",null,"What\u2019s \u201cBEGIN (implicit)\u201d?"),(0,o.kt)("p",null,"You might have noticed the log line \u201cBEGIN (implicit)\u201d at the start of a transaction block. \u201cimplicit\u201d here means that SQLAlchemy  ",(0,o.kt)("strong",{parentName:"p"},"did not actually send any command"),"  to the database; it just considers this to be the start of the DBAPI\u2019s implicit transaction. You can register  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/events.html#core-sql-events"},"event hooks"),"  to intercept this event, for example."),(0,o.kt)("p",null,"[",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/tutorial/dbapi_transactions.html#id1"},"1"),"]"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/glossary.html#term-DDL"},"DDL"),"  refers to the subset of SQL that instructs the database to create, modify, or remove schema-level constructs such as tables. DDL such as \u201cCREATE TABLE\u201d is recommended to be within a transaction block that ends with COMMIT, as many databases uses transactional DDL such that the schema changes don\u2019t take place until the transaction is committed. However, as we\u2019ll see later, we usually let SQLAlchemy run DDL sequences for us as part of a higher level operation where we don\u2019t generally need to worry about the COMMIT."),(0,o.kt)("h2",{id:"basics-of-statement-executionpermalink-to-this-heading"},"Basics of Statement Execution",(0,o.kt)("a",{parentName:"h2",href:"https://docs.sqlalchemy.org/en/20/tutorial/dbapi_transactions.html#basics-of-statement-execution",title:"Permalink to this heading"})),(0,o.kt)("p",null,"We have seen a few examples that run SQL statements against a database, making use of a method called  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Connection.execute",title:"sqlalchemy.engine.Connection.execute"},(0,o.kt)("inlineCode",{parentName:"a"},"Connection.execute()")),", in conjunction with an object called  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/sqlelement.html#sqlalchemy.sql.expression.text",title:"sqlalchemy.sql.expression.text"},(0,o.kt)("inlineCode",{parentName:"a"},"text()")),", and returning an object called  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Result",title:"sqlalchemy.engine.Result"},(0,o.kt)("inlineCode",{parentName:"a"},"Result")),". In this section we\u2019ll illustrate more closely the mechanics and interactions of these components."),(0,o.kt)("p",null,"Most of the content in this section applies equally well to modern ORM use when using the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/orm/session_api.html#sqlalchemy.orm.Session.execute",title:"sqlalchemy.orm.Session.execute"},(0,o.kt)("inlineCode",{parentName:"a"},"Session.execute()")),"  method, which works very similarly to that of  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Connection.execute",title:"sqlalchemy.engine.Connection.execute"},(0,o.kt)("inlineCode",{parentName:"a"},"Connection.execute()")),", including that ORM result rows are delivered using the same  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Result",title:"sqlalchemy.engine.Result"},(0,o.kt)("inlineCode",{parentName:"a"},"Result")),"  interface used by Core."),(0,o.kt)("h3",{id:"fetching-rowspermalink-to-this-heading"},"Fetching Rows",(0,o.kt)("a",{parentName:"h3",href:"https://docs.sqlalchemy.org/en/20/tutorial/dbapi_transactions.html#fetching-rows",title:"Permalink to this heading"})),(0,o.kt)("p",null,"We\u2019ll first illustrate the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Result",title:"sqlalchemy.engine.Result"},(0,o.kt)("inlineCode",{parentName:"a"},"Result")),"  object more closely by making use of the rows we\u2019ve inserted previously, running a textual SELECT statement on the table we\u2019ve created:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'>>> with engine.connect() as conn:\n...     result = conn.execute(text("SELECT x, y FROM some_table"))\n...     for row in result:\n...         print(f"x: {row.x} y: {row.y}")\n\nBEGIN  (implicit)\nSELECT  x,  y  FROM  some_table\n[...]  ()\n\nx: 1  y: 1\nx: 2  y: 4\nx: 6  y: 8\nx: 9  y: 10\n\nROLLBACK\n')),(0,o.kt)("p",null,"Above, the \u201cSELECT\u201d string we executed selected all rows from our table. The object returned is called  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Result",title:"sqlalchemy.engine.Result"},(0,o.kt)("inlineCode",{parentName:"a"},"Result")),"  and represents an iterable object of result rows."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Result",title:"sqlalchemy.engine.Result"},(0,o.kt)("inlineCode",{parentName:"a"},"Result")),"  has lots of methods for fetching and transforming rows, such as the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Result.all",title:"sqlalchemy.engine.Result.all"},(0,o.kt)("inlineCode",{parentName:"a"},"Result.all()")),"  method illustrated previously, which returns a list of all  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Row",title:"sqlalchemy.engine.Row"},(0,o.kt)("inlineCode",{parentName:"a"},"Row")),"  objects. It also implements the Python iterator interface so that we can iterate over the collection of  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Row",title:"sqlalchemy.engine.Row"},(0,o.kt)("inlineCode",{parentName:"a"},"Row")),"  objects directly."),(0,o.kt)("p",null,"The  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Row",title:"sqlalchemy.engine.Row"},(0,o.kt)("inlineCode",{parentName:"a"},"Row")),"  objects themselves are intended to act like Python  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.python.org/3/library/collections.html#collections.namedtuple"},"named tuples"),". Below we illustrate a variety of ways to access rows."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Tuple Assignment"),"  - This is the most Python-idiomatic style, which is to assign variables to each row positionally as they are received:"),(0,o.kt)("p",{parentName:"li"},'result = conn.execute(text("select x, y from some_table"))'),(0,o.kt)("p",{parentName:"li"},"for x, y in result:\n...")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Integer Index"),"  - Tuples are Python sequences, so regular integer access is available too:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-python"},'   result = conn.execute(text("select x, y from some_table"))\n   \n   for row in result:\n       x = row[0]\n'))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Attribute Name"),"  - As these are Python named tuples, the tuples have dynamic attribute names matching the names of each column. These names are normally the names that the SQL statement assigns to the columns in each row. While they are usually fairly predictable and can also be controlled by labels, in less defined cases they may be subject to database-specific behaviors:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-python"},'  result = conn.execute(text("select x, y from some_table"))\n  \n  for row in result:\n      y = row.y\n  \n      # illustrate use with Python f-strings\n      print(f"Row: {row.x}  {y}")\n'))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Mapping Access"),"  - To receive rows as Python  ",(0,o.kt)("strong",{parentName:"p"},"mapping"),"  objects, which is essentially a read-only version of Python\u2019s interface to the common  ",(0,o.kt)("inlineCode",{parentName:"p"},"dict"),"  object, the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Result",title:"sqlalchemy.engine.Result"},(0,o.kt)("inlineCode",{parentName:"a"},"Result")),"  may be  ",(0,o.kt)("strong",{parentName:"p"},"transformed"),"  into a  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.MappingResult",title:"sqlalchemy.engine.MappingResult"},(0,o.kt)("inlineCode",{parentName:"a"},"MappingResult")),"  object using the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Result.mappings",title:"sqlalchemy.engine.Result.mappings"},(0,o.kt)("inlineCode",{parentName:"a"},"Result.mappings()")),"  modifier; this is a result object that yields dictionary-like  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.RowMapping",title:"sqlalchemy.engine.RowMapping"},(0,o.kt)("inlineCode",{parentName:"a"},"RowMapping")),"  objects rather than  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Row",title:"sqlalchemy.engine.Row"},(0,o.kt)("inlineCode",{parentName:"a"},"Row")),"  objects:"),(0,o.kt)("p",{parentName:"li"},'result = conn.execute(text("select x, y from some_table"))'),(0,o.kt)("p",{parentName:"li"},"for dict_row in result.mappings():\nx = dict_row",'["x"]',"\ny = dict_row",'["y"]'))),(0,o.kt)("h3",{id:"sending-parameterspermalink-to-this-heading"},"Sending Parameters",(0,o.kt)("a",{parentName:"h3",href:"https://docs.sqlalchemy.org/en/20/tutorial/dbapi_transactions.html#sending-parameters",title:"Permalink to this heading"})),(0,o.kt)("p",null,"SQL statements are usually accompanied by data that is to be passed with the statement itself, as we saw in the INSERT example previously. The  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Connection.execute",title:"sqlalchemy.engine.Connection.execute"},(0,o.kt)("inlineCode",{parentName:"a"},"Connection.execute()")),"  method therefore also accepts parameters, which are referred towards as  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/glossary.html#term-bound-parameters"},"bound parameters"),". A rudimentary example might be if we wanted to limit our SELECT statement only to rows that meet a certain criteria, such as rows where the \u201cy\u201d value were greater than a certain value that is passed in to a function."),(0,o.kt)("p",null,"In order to achieve this such that the SQL statement can remain fixed and that the driver can properly sanitize the value, we add a WHERE criteria to our statement that names a new parameter called \u201cy\u201d; the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/sqlelement.html#sqlalchemy.sql.expression.text",title:"sqlalchemy.sql.expression.text"},(0,o.kt)("inlineCode",{parentName:"a"},"text()")),"  construct accepts these using a colon format \u201c",(0,o.kt)("inlineCode",{parentName:"p"},":y"),"\u201d. The actual value for \u201c",(0,o.kt)("inlineCode",{parentName:"p"},":y"),"\u201d is then passed as the second argument to  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Connection.execute",title:"sqlalchemy.engine.Connection.execute"},(0,o.kt)("inlineCode",{parentName:"a"},"Connection.execute()")),"  in the form of a dictionary:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'>>> with engine.connect() as conn:\n...     result = conn.execute(text("SELECT x, y FROM some_table WHERE y > :y"), {"y": 2})\n...     for row in result:\n...         print(f"x: {row.x} y: {row.y}")\n\nBEGIN  (implicit)\nSELECT  x,  y  FROM  some_table  WHERE  y  >  ?\n[...]  (2,)\n\nx: 2  y: 4\nx: 6  y: 8\nx: 9  y: 10\n\nROLLBACK\n')),(0,o.kt)("p",null,"In the logged SQL output, we can see that the bound parameter  ",(0,o.kt)("inlineCode",{parentName:"p"},":y"),"  was converted into a question mark when it was sent to the SQLite database. This is because the SQLite database driver uses a format called \u201cqmark parameter style\u201d, which is one of six different formats allowed by the DBAPI specification. SQLAlchemy abstracts these formats into just one, which is the \u201cnamed\u201d format using a colon."),(0,o.kt)("p",null,"Always use bound parameters"),(0,o.kt)("p",null,"As mentioned at the beginning of this section, textual SQL is not the usual way we work with SQLAlchemy. However, when using textual SQL, a Python literal value, even non-strings like integers or dates, should  ",(0,o.kt)("strong",{parentName:"p"},"never be stringified into SQL string directly"),"; a parameter should  ",(0,o.kt)("strong",{parentName:"p"},"always"),"  be used. This is most famously known as how to avoid SQL injection attacks when the data is untrusted. However it also allows the SQLAlchemy dialects and/or DBAPI to correctly handle the incoming input for the backend. Outside of plain textual SQL use cases, SQLAlchemy\u2019s Core Expression API otherwise ensures that Python literal values are passed as bound parameters where appropriate."),(0,o.kt)("h3",{id:"sending-multiple-parameterspermalink-to-this-heading"},"Sending Multiple Parameters",(0,o.kt)("a",{parentName:"h3",href:"https://docs.sqlalchemy.org/en/20/tutorial/dbapi_transactions.html#sending-multiple-parameters",title:"Permalink to this heading"})),(0,o.kt)("p",null,"In the example at  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/tutorial/dbapi_transactions.html#tutorial-committing-data"},"Committing Changes"),", we executed an INSERT statement where it appeared that we were able to INSERT multiple rows into the database at once. For statements  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/glossary.html#term-DML"},"DML"),"  statements such as \u201cINSERT\u201d, \u201cUPDATE\u201d and \u201cDELETE\u201d, we can send  ",(0,o.kt)("strong",{parentName:"p"},"multiple parameter sets"),"  to the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Connection.execute",title:"sqlalchemy.engine.Connection.execute"},(0,o.kt)("inlineCode",{parentName:"a"},"Connection.execute()")),"  method by passing a list of dictionaries instead of a single dictionary, which indicates that the single SQL statement should be invoked multiple times, once for each parameter set. This style of execution is known as  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/glossary.html#term-executemany"},"executemany"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'>>> with engine.connect() as conn:\n...     conn.execute(\n...         text("INSERT INTO some_table (x, y) VALUES (:x, :y)"),\n...         [{"x": 11, "y": 12}, {"x": 13, "y": 14}],\n...     )\n...     conn.commit()\n\nBEGIN  (implicit)\nINSERT  INTO  some_table  (x,  y)  VALUES  (?,  ?)\n[...]  [(11,  12),  (13,  14)]\n<sqlalchemy.engine.cursor.CursorResult  object  at  0x...>\nCOMMIT\n')),(0,o.kt)("p",null,"The above operation is equivalent to running the given INSERT statement once for each parameter set, except that the operation will be optimized for better performance across many rows."),(0,o.kt)("p",null,"A key behavioral difference between \u201cexecute\u201d and \u201cexecutemany\u201d is that the latter doesn\u2019t support returning of result rows, even if the statement includes the RETURNING clause. The one exception to this is when using a Core  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/dml.html#sqlalchemy.sql.expression.insert",title:"sqlalchemy.sql.expression.insert"},(0,o.kt)("inlineCode",{parentName:"a"},"insert()")),"  construct, introduced later in this tutorial at  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/tutorial/data_insert.html#tutorial-core-insert"},"Inserting Rows with Core"),", which also indicates RETURNING using the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/dml.html#sqlalchemy.sql.expression.Insert.returning",title:"sqlalchemy.sql.expression.Insert.returning"},(0,o.kt)("inlineCode",{parentName:"a"},"Insert.returning()")),"  method. In that case, SQLAlchemy makes use of special logic to reorganize the INSERT statement so that it can be invoked for many rows while still supporting RETURNING."),(0,o.kt)("p",null,"See also"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/glossary.html#term-executemany"},"executemany"),"  - in the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/glossary.html"},"Glossary"),", describes the DBAPI-level  ",(0,o.kt)("a",{parentName:"p",href:"https://peps.python.org/pep-0249/#executemany"},"cursor.executemany()"),"  method that\u2019s used for most \u201cexecutemany\u201d executions."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#engine-insertmanyvalues"},"\u201cInsert Many Values\u201d Behavior for INSERT statements"),"  - in  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html"},"Working with Engines and Connections"),", describes the specialized logic used by  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/dml.html#sqlalchemy.sql.expression.Insert.returning",title:"sqlalchemy.sql.expression.Insert.returning"},(0,o.kt)("inlineCode",{parentName:"a"},"Insert.returning()")),"  to deliver result sets with \u201cexecutemany\u201d executions."),(0,o.kt)("h2",{id:"executing-with-an-orm-sessionpermalink-to-this-heading"},"Executing with an ORM Session",(0,o.kt)("a",{parentName:"h2",href:"https://docs.sqlalchemy.org/en/20/tutorial/dbapi_transactions.html#executing-with-an-orm-session",title:"Permalink to this heading"})),(0,o.kt)("p",null,"As mentioned previously, most of the patterns and examples above apply to use with the ORM as well, so here we will introduce this usage so that as the tutorial proceeds, we will be able to illustrate each pattern in terms of Core and ORM use together."),(0,o.kt)("p",null,"The fundamental transactional / database interactive object when using the ORM is called the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/orm/session_api.html#sqlalchemy.orm.Session",title:"sqlalchemy.orm.Session"},(0,o.kt)("inlineCode",{parentName:"a"},"Session")),". In modern SQLAlchemy, this object is used in a manner very similar to that of the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Connection",title:"sqlalchemy.engine.Connection"},(0,o.kt)("inlineCode",{parentName:"a"},"Connection")),", and in fact as the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/orm/session_api.html#sqlalchemy.orm.Session",title:"sqlalchemy.orm.Session"},(0,o.kt)("inlineCode",{parentName:"a"},"Session")),"  is used, it refers to a  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Connection",title:"sqlalchemy.engine.Connection"},(0,o.kt)("inlineCode",{parentName:"a"},"Connection")),"  internally which it uses to emit SQL."),(0,o.kt)("p",null,"When the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/orm/session_api.html#sqlalchemy.orm.Session",title:"sqlalchemy.orm.Session"},(0,o.kt)("inlineCode",{parentName:"a"},"Session")),"  is used with non-ORM constructs, it passes through the SQL statements we give it and does not generally do things much differently from how the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Connection",title:"sqlalchemy.engine.Connection"},(0,o.kt)("inlineCode",{parentName:"a"},"Connection")),"  does directly, so we can illustrate it here in terms of the simple textual SQL operations we\u2019ve already learned."),(0,o.kt)("p",null,"The  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/orm/session_api.html#sqlalchemy.orm.Session",title:"sqlalchemy.orm.Session"},(0,o.kt)("inlineCode",{parentName:"a"},"Session")),"  has a few different creational patterns, but here we will illustrate the most basic one that tracks exactly with how the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Connection",title:"sqlalchemy.engine.Connection"},(0,o.kt)("inlineCode",{parentName:"a"},"Connection")),"  is used which is to construct it within a context manager:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'>>> from sqlalchemy.orm import Session\n\n>>> stmt = text("SELECT x, y FROM some_table WHERE y > :y ORDER BY x, y")\n>>> with Session(engine) as session:\n...     result = session.execute(stmt, {"y": 6})\n...     for row in result:\n...         print(f"x: {row.x} y: {row.y}")\n\nBEGIN  (implicit)\nSELECT  x,  y  FROM  some_table  WHERE  y  >  ?  ORDER  BY  x,  y\n[...]  (6,)\n\nx: 6  y: 8\nx: 9  y: 10\nx: 11  y: 12\nx: 13  y: 14\n\nROLLBACK\n')),(0,o.kt)("p",null,"The example above can be compared to the example in the preceding section in  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/tutorial/dbapi_transactions.html#tutorial-sending-parameters"},"Sending Parameters"),"  - we directly replace the call to  ",(0,o.kt)("inlineCode",{parentName:"p"},"with  engine.connect()  as  conn"),"  with  ",(0,o.kt)("inlineCode",{parentName:"p"},"with  Session(engine)  as  session"),", and then make use of the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/orm/session_api.html#sqlalchemy.orm.Session.execute",title:"sqlalchemy.orm.Session.execute"},(0,o.kt)("inlineCode",{parentName:"a"},"Session.execute()")),"  method just like we do with the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Connection.execute",title:"sqlalchemy.engine.Connection.execute"},(0,o.kt)("inlineCode",{parentName:"a"},"Connection.execute()")),"  method."),(0,o.kt)("p",null,"Also, like the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Connection",title:"sqlalchemy.engine.Connection"},(0,o.kt)("inlineCode",{parentName:"a"},"Connection")),", the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/orm/session_api.html#sqlalchemy.orm.Session",title:"sqlalchemy.orm.Session"},(0,o.kt)("inlineCode",{parentName:"a"},"Session")),"  features \u201ccommit as you go\u201d behavior using the  ",(0,o.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/20/orm/session_api.html#sqlalchemy.orm.Session.commit",title:"sqlalchemy.orm.Session.commit"},(0,o.kt)("inlineCode",{parentName:"a"},"Session.commit()")),"  method, illustrated below using a textual UPDATE statement to alter some of our data:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'>>> with Session(engine) as session:\n...     result = session.execute(\n...         text("UPDATE some_table SET y=:y WHERE x=:x"),\n...         [{"x": 9, "y": 11}, {"x": 13, "y": 15}],\n...     )\n...     session.commit()\n\nBEGIN  (implicit)\nUPDATE  some_table  SET  y=?  WHERE  x=?\n[...]  [(11,  9),  (15,  13)]\nCOMMIT\n')))}m.isMDXComponent=!0}}]);